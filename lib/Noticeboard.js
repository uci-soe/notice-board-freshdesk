import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Container, ListGroup } from 'reactstrap';
import './Noticeboard.css';
import qs from 'qs';
import NoticeboardItem from './NoticeboardItem';

const TicketsNoTickets = () => {
  return React.createElement("div", {
    className: "no-tickets"
  });
};

const ONE_MINUTE = 1000 * 60;

const buildQuery = params => {
  let q = [];
  let status = ['status:<2'];

  if (params.displayPending) {
    status.push('status:3');
  }

  if (params.displayResolved) {
    status.push('status:>4');
  }

  q.push('(' + status.join(' OR ') + ')');

  if (params.agent) {
    q.push(`agent_id:${params.agent}`);
  }

  if (params.updated_since) {
    q.push(`updated_at:>'${params.updated_since}'`);
  }

  return '"' + q.join(' AND ') + '"';
};

const ticketsGenerator = (subdomain, auth) => {
  const paramsSerializer = params => {
    return qs.stringify(params, {
      arrayFormat: 'brackets',
      encoder: function (str) {
        // Passed in values `a`, `b`, `c`
        return typeof str === 'string' ? str.trim().replace(/\s+/g, '%20') : str;
      }
    });
  };

  const call = (endpoint, params) => {
    return axios.get(`https://${subdomain}.freshdesk.com/api/v2/${endpoint}`, {
      auth,
      params,
      paramsSerializer
    }).then(response => response.data);
  };

  const all = params => {
    return call('search/tickets', {
      query: buildQuery(params)
    }).catch(err => {
      console.error(err.stack);
      return {
        total: 0,
        results: []
      };
    });
  };

  const one = (id, params) => {
    return call(`tickets/${id}`, {
      include: 'requester,conversations'
    }).catch(err => {
      console.error(err.stack);
      return {};
    });
  };

  return {
    one,
    all
  };
};

const fetchResponse = (subdomain, auth, opts) => {
  return axios.get(`https://${subdomain}.freshdesk.com/api/v2/tickets`, {
    auth: auth,
    params: {
      include: 'requester,description',
      ...buildQuery(opts)
    },
    paramsSerializer: function (params) {
      return qs.stringify(params, {
        arrayFormat: 'brackets',
        encoder: function (str) {
          // Passed in values `a`, `b`, `c`
          return typeof str === 'string' ? str.trim().replace(/\s+/g, '%20') : str;
        }
      });
    }
  }).then(response => response.data).catch(err => {
    console.error(err.stack);
    return [];
  });
};

const Noticeboard = ({
  children,
  auth = {},
  subdomain = '',
  agent = 0,
  // our student agent is 2043025904255
  displayResolved = false,
  displayPending = true,
  updated_since = null,
  limit = -1,
  // will now have a max of 30, but a silent max
  // page = 0,     // just cant find a reasonable way to make it work
  // order_by = 'created_at',  // couldn't make this work with query // order is now always newest to oldest
  // order_type = 'desc', // couldn't make this work with query
  noTickets
}) => {
  const [response, setResponse] = useState([]);
  useEffect(() => {
    let update;
    const tickets = ticketsGenerator(subdomain, auth);

    const updateFunc = () => {
      // fetchResponse(subdomain, auth, {order_by, order_type, displayResolved, updated_since, limit, page})
      //   .then(resp => limit >= 0 ? resp.slice(0, limit) : resp)
      //   .then(resp => setResponse(resp))
      // ;
      const params = {
        agent,
        displayResolved,
        displayPending,
        updated_since
      };
      tickets.all(params).then(({
        total,
        results
      }) => {
        /*
          Using the Freshdesk Query endpoint, instead of the list endpoint, there is no sort or limit and
          pagination would be painful.
          Luckily in our case we only need to show recent things and are unlikely to have more than a dozen at
          any time. So we will only care about limits from 1-30.
         */
        if (limit > -1 && limit < 30) {
          results = results.slice(0, limit);
        }

        return {
          total,
          results
        };
      }).then(({
        total,
        results
      }) => Promise.all(results.map(t => tickets.one(t.id, params)))).then(resp => setResponse(resp));
      update = setTimeout(() => {
        updateFunc();
      }, 5 * ONE_MINUTE);
    };

    updateFunc();
    return () => {
      clearTimeout(update);
    }; // fetchResponse(subdomain, auth, {order_by, order_type, updated_since, displayResolved, limit, page})
    //   .then(resp => setResponse(resp))
    // ;
  }, [subdomain, auth, displayResolved, displayPending, updated_since, agent]);
  const fsItem = children || NoticeboardItem;
  const NoTickets = noTickets || TicketsNoTickets; // console.log(fsItem);

  return React.createElement(ListGroup, {
    className: "tickets"
  }, response.length ? response.map(ticket => fsItem({
    ticket,
    key: ticket.id
  })) : NoTickets());
};

export default Noticeboard;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL05vdGljZWJvYXJkLmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwidXNlU3RhdGUiLCJ1c2VFZmZlY3QiLCJheGlvcyIsIkNvbnRhaW5lciIsIkxpc3RHcm91cCIsInFzIiwiTm90aWNlYm9hcmRJdGVtIiwiVGlja2V0c05vVGlja2V0cyIsIk9ORV9NSU5VVEUiLCJidWlsZFF1ZXJ5IiwicGFyYW1zIiwicSIsInN0YXR1cyIsImRpc3BsYXlQZW5kaW5nIiwicHVzaCIsImRpc3BsYXlSZXNvbHZlZCIsImpvaW4iLCJhZ2VudCIsInVwZGF0ZWRfc2luY2UiLCJ0aWNrZXRzR2VuZXJhdG9yIiwic3ViZG9tYWluIiwiYXV0aCIsInBhcmFtc1NlcmlhbGl6ZXIiLCJzdHJpbmdpZnkiLCJhcnJheUZvcm1hdCIsImVuY29kZXIiLCJzdHIiLCJ0cmltIiwicmVwbGFjZSIsImNhbGwiLCJlbmRwb2ludCIsImdldCIsInRoZW4iLCJyZXNwb25zZSIsImRhdGEiLCJhbGwiLCJxdWVyeSIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJ0b3RhbCIsInJlc3VsdHMiLCJvbmUiLCJpZCIsImluY2x1ZGUiLCJmZXRjaFJlc3BvbnNlIiwib3B0cyIsIk5vdGljZWJvYXJkIiwiY2hpbGRyZW4iLCJsaW1pdCIsIm5vVGlja2V0cyIsInNldFJlc3BvbnNlIiwidXBkYXRlIiwidGlja2V0cyIsInVwZGF0ZUZ1bmMiLCJzbGljZSIsIlByb21pc2UiLCJtYXAiLCJ0IiwicmVzcCIsInNldFRpbWVvdXQiLCJjbGVhclRpbWVvdXQiLCJmc0l0ZW0iLCJOb1RpY2tldHMiLCJsZW5ndGgiLCJ0aWNrZXQiLCJrZXkiXSwibWFwcGluZ3MiOiJBQUFBLE9BQU9BLEtBQVAsSUFBZUMsUUFBZixFQUF5QkMsU0FBekIsUUFBeUMsT0FBekM7QUFDQSxPQUFPQyxLQUFQLE1BQWtCLE9BQWxCO0FBQ0EsU0FDRUMsU0FERixFQUVFQyxTQUZGLFFBR08s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QUFTLEVBSGQsQ0FERjtBQU9ELENBekVEOztBQTJFQSxlQUFlaEIsV0FBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwge3VzZVN0YXRlLCB1c2VFZmZlY3R9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQge1xuICBDb250YWluZXIsXG4gIExpc3RHcm91cFxufSBmcm9tICdyZWFjdHN0cmFwJztcbmltcG9ydCAnLi9Ob3RpY2Vib2FyZC5jc3MnO1xuaW1wb3J0IHFzIGZyb20gJ3FzJztcbmltcG9ydCBOb3RpY2Vib2FyZEl0ZW0gZnJvbSAnLi9Ob3RpY2Vib2FyZEl0ZW0nO1xuXG5jb25zdCBUaWNrZXRzTm9UaWNrZXRzID0gKCkgPT4ge1xuICByZXR1cm4gKDxkaXYgY2xhc3NOYW1lPVwibm8tdGlja2V0c1wiIC8+KTtcbn07XG5cbmNvbnN0IE9ORV9NSU5VVEUgPSAxMDAwICogNjA7XG5cbmNvbnN0IGJ1aWxkUXVlcnkgPSAocGFyYW1zKSA9PiB7XG4gIGxldCBxID0gW107XG5cbiAgbGV0IHN0YXR1cyA9IFsnc3RhdHVzOjwyJ107XG4gIGlmIChwYXJhbXMuZGlzcGxheVBlbmRpbmcpIHtcbiAgICBzdGF0dXMucHVzaCgnc3RhdHVzOjMnKTtcbiAgfVxuICBpZiAocGFyYW1zLmRpc3BsYXlSZXNvbHZlZCkge1xuICAgIHN0YXR1cy5wdXNoKCdzdGF0dXM6PjQnKTtcbiAgfVxuICBxLnB1c2goJygnICsgc3RhdHVzLmpvaW4oJyBPUiAnKSArICcpJyk7XG5cbiAgaWYgKHBhcmFtcy5hZ2VudCkge1xuICAgIHEucHVzaChgYWdlbnRfaWQ6JHtwYXJhbXMuYWdlbnR9YCk7XG4gIH1cbiAgaWYgKHBhcmFtcy51cGRhdGVkX3NpbmNlKSB7XG4gICAgcS5wdXNoKGB1cGRhdGVkX2F0Oj4nJHtwYXJhbXMudXBkYXRlZF9zaW5jZX0nYCk7XG4gIH1cblxuICByZXR1cm4gJ1wiJyArIHEuam9pbignIEFORCAnKSArICdcIic7XG59O1xuXG5jb25zdCB0aWNrZXRzR2VuZXJhdG9yID0gKHN1YmRvbWFpbiwgYXV0aCkgPT4ge1xuICBjb25zdCBwYXJhbXNTZXJpYWxpemVyID0gKHBhcmFtcykgPT4ge1xuICAgIHJldHVybiBxcy5zdHJpbmdpZnkocGFyYW1zLCB7XG4gICAgICBhcnJheUZvcm1hdDogJ2JyYWNrZXRzJyxcbiAgICAgIGVuY29kZXI6ICAgICBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICAgIC8vIFBhc3NlZCBpbiB2YWx1ZXMgYGFgLCBgYmAsIGBjYFxuICAgICAgICByZXR1cm4gdHlwZW9mIHN0ciA9PT0gJ3N0cmluZycgPyBzdHIudHJpbSgpLnJlcGxhY2UoL1xccysvZywgJyUyMCcpIDogc3RyO1xuICAgICAgfVxuICAgIH0pXG4gIH07XG4gIGNvbnN0IGNhbGwgICAgICAgICAgICAgPSAoZW5kcG9pbnQsIHBhcmFtcykgPT4ge1xuICAgIHJldHVybiBheGlvc1xuICAgICAgLmdldChgaHR0cHM6Ly8ke3N1YmRvbWFpbn0uZnJlc2hkZXNrLmNvbS9hcGkvdjIvJHtlbmRwb2ludH1gLCB7YXV0aCwgcGFyYW1zLCBwYXJhbXNTZXJpYWxpemVyfSlcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmRhdGEpXG4gICAgICA7XG4gIH07XG5cbiAgY29uc3QgYWxsID0gKHBhcmFtcykgPT4ge1xuICAgIHJldHVybiBjYWxsKCdzZWFyY2gvdGlja2V0cycsIHtcbiAgICAgIHF1ZXJ5OiBidWlsZFF1ZXJ5KHBhcmFtcyksXG4gICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayk7XG4gICAgICAgIHJldHVybiB7dG90YWw6IDAsIHJlc3VsdHM6IFtdfTtcbiAgICAgIH0pXG5cbiAgfTtcbiAgY29uc3Qgb25lID0gKGlkLCBwYXJhbXMpID0+IHtcbiAgICByZXR1cm4gY2FsbChgdGlja2V0cy8ke2lkfWAsIHtcbiAgICAgIGluY2x1ZGU6ICdyZXF1ZXN0ZXIsY29udmVyc2F0aW9ucycsXG4gICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0pXG5cbiAgfTtcblxuXG4gIHJldHVybiB7b25lLCBhbGx9O1xufTtcblxuXG5jb25zdCBmZXRjaFJlc3BvbnNlID0gKHN1YmRvbWFpbiwgYXV0aCwgb3B0cykgPT4ge1xuICByZXR1cm4gYXhpb3MuZ2V0KGBodHRwczovLyR7c3ViZG9tYWlufS5mcmVzaGRlc2suY29tL2FwaS92Mi90aWNrZXRzYCwge1xuICAgIGF1dGg6ICAgICAgICAgICAgIGF1dGgsXG4gICAgcGFyYW1zOiAgICAgICAgICAge1xuICAgICAgaW5jbHVkZTogJ3JlcXVlc3RlcixkZXNjcmlwdGlvbicsXG4gICAgICAuLi5idWlsZFF1ZXJ5KG9wdHMpXG4gICAgfSxcbiAgICBwYXJhbXNTZXJpYWxpemVyOiBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICByZXR1cm4gcXMuc3RyaW5naWZ5KHBhcmFtcywge1xuICAgICAgICBhcnJheUZvcm1hdDogJ2JyYWNrZXRzJywgZW5jb2RlcjogZnVuY3Rpb24gKHN0cikge1xuICAgICAgICAgIC8vIFBhc3NlZCBpbiB2YWx1ZXMgYGFgLCBgYmAsIGBjYFxuICAgICAgICAgIHJldHVybiB0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyA/IHN0ci50cmltKCkucmVwbGFjZSgvXFxzKy9nLCAnJTIwJykgOiBzdHI7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSxcbiAgfSkudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5kYXRhKVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2spO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH0pO1xufTtcblxuY29uc3QgTm90aWNlYm9hcmQgPSAoXG4gIHtcbiAgICBjaGlsZHJlbixcbiAgICBhdXRoID0ge30sXG4gICAgc3ViZG9tYWluID0gJycsXG4gICAgYWdlbnQgPSAwLCAvLyBvdXIgc3R1ZGVudCBhZ2VudCBpcyAyMDQzMDI1OTA0MjU1XG4gICAgZGlzcGxheVJlc29sdmVkID0gZmFsc2UsXG4gICAgZGlzcGxheVBlbmRpbmcgPSB0cnVlLFxuICAgIHVwZGF0ZWRfc2luY2UgPSBudWxsLFxuICAgIGxpbWl0ID0gLTEsICAgLy8gd2lsbCBub3cgaGF2ZSBhIG1heCBvZiAzMCwgYnV0IGEgc2lsZW50IG1heFxuICAgIC8vIHBhZ2UgPSAwLCAgICAgLy8ganVzdCBjYW50IGZpbmQgYSByZWFzb25hYmxlIHdheSB0byBtYWtlIGl0IHdvcmtcbiAgICAvLyBvcmRlcl9ieSA9ICdjcmVhdGVkX2F0JywgIC8vIGNvdWxkbid0IG1ha2UgdGhpcyB3b3JrIHdpdGggcXVlcnkgLy8gb3JkZXIgaXMgbm93IGFsd2F5cyBuZXdlc3QgdG8gb2xkZXN0XG4gICAgLy8gb3JkZXJfdHlwZSA9ICdkZXNjJywgLy8gY291bGRuJ3QgbWFrZSB0aGlzIHdvcmsgd2l0aCBxdWVyeVxuICAgIG5vVGlja2V0c1xuICB9XG4pID0+IHtcblxuICBjb25zdCBbcmVzcG9uc2UsIHNldFJlc3BvbnNlXSA9IHVzZVN0YXRlKFtdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGxldCB1cGRhdGU7XG4gICAgY29uc3QgdGlja2V0cyAgICA9IHRpY2tldHNHZW5lcmF0b3Ioc3ViZG9tYWluLCBhdXRoKTtcbiAgICBjb25zdCB1cGRhdGVGdW5jID0gKCkgPT4ge1xuICAgICAgLy8gZmV0Y2hSZXNwb25zZShzdWJkb21haW4sIGF1dGgsIHtvcmRlcl9ieSwgb3JkZXJfdHlwZSwgZGlzcGxheVJlc29sdmVkLCB1cGRhdGVkX3NpbmNlLCBsaW1pdCwgcGFnZX0pXG4gICAgICAvLyAgIC50aGVuKHJlc3AgPT4gbGltaXQgPj0gMCA/IHJlc3Auc2xpY2UoMCwgbGltaXQpIDogcmVzcClcbiAgICAgIC8vICAgLnRoZW4ocmVzcCA9PiBzZXRSZXNwb25zZShyZXNwKSlcbiAgICAgIC8vIDtcblxuICAgICAgY29uc3QgcGFyYW1zID0ge2FnZW50LCBkaXNwbGF5UmVzb2x2ZWQsIGRpc3BsYXlQZW5kaW5nLCB1cGRhdGVkX3NpbmNlfTtcbiAgICAgIHRpY2tldHMuYWxsKHBhcmFtcylcbiAgICAgICAgLnRoZW4oKHt0b3RhbCwgcmVzdWx0c30pID0+IHtcbiAgICAgICAgICAvKlxuICAgICAgICAgICAgVXNpbmcgdGhlIEZyZXNoZGVzayBRdWVyeSBlbmRwb2ludCwgaW5zdGVhZCBvZiB0aGUgbGlzdCBlbmRwb2ludCwgdGhlcmUgaXMgbm8gc29ydCBvciBsaW1pdCBhbmRcbiAgICAgICAgICAgIHBhZ2luYXRpb24gd291bGQgYmUgcGFpbmZ1bC5cbiAgICAgICAgICAgIEx1Y2tpbHkgaW4gb3VyIGNhc2Ugd2Ugb25seSBuZWVkIHRvIHNob3cgcmVjZW50IHRoaW5ncyBhbmQgYXJlIHVubGlrZWx5IHRvIGhhdmUgbW9yZSB0aGFuIGEgZG96ZW4gYXRcbiAgICAgICAgICAgIGFueSB0aW1lLiBTbyB3ZSB3aWxsIG9ubHkgY2FyZSBhYm91dCBsaW1pdHMgZnJvbSAxLTMwLlxuICAgICAgICAgICAqL1xuICAgICAgICAgIGlmIChsaW1pdCA+IC0xICYmIGxpbWl0IDwgMzApIHtcbiAgICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLnNsaWNlKDAsIGxpbWl0KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHsgdG90YWwsIHJlc3VsdHMgfVxuICAgICAgICB9KVxuICAgICAgICAudGhlbigoe3RvdGFsLCByZXN1bHRzfSkgPT4gUHJvbWlzZS5hbGwocmVzdWx0cy5tYXAodCA9PiB0aWNrZXRzLm9uZSh0LmlkLCBwYXJhbXMpKSkpXG4gICAgICAgIC50aGVuKHJlc3AgPT4gc2V0UmVzcG9uc2UocmVzcCkpXG4gICAgICA7XG5cblxuICAgICAgdXBkYXRlID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHVwZGF0ZUZ1bmMoKTtcbiAgICAgIH0sIDUgKiBPTkVfTUlOVVRFKTtcbiAgICB9O1xuXG4gICAgdXBkYXRlRnVuYygpO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNsZWFyVGltZW91dCh1cGRhdGUpO1xuICAgIH1cbiAgICAvLyBmZXRjaFJlc3BvbnNlKHN1YmRvbWFpbiwgYXV0aCwge29yZGVyX2J5LCBvcmRlcl90eXBlLCB1cGRhdGVkX3NpbmNlLCBkaXNwbGF5UmVzb2x2ZWQsIGxpbWl0LCBwYWdlfSlcbiAgICAvLyAgIC50aGVuKHJlc3AgPT4gc2V0UmVzcG9uc2UocmVzcCkpXG4gICAgLy8gO1xuXG4gIH0sIFtzdWJkb21haW4sIGF1dGgsIGRpc3BsYXlSZXNvbHZlZCwgZGlzcGxheVBlbmRpbmcsIHVwZGF0ZWRfc2luY2UsIGFnZW50XSk7XG5cbiAgY29uc3QgZnNJdGVtICAgID0gY2hpbGRyZW4gfHwgTm90aWNlYm9hcmRJdGVtO1xuICBjb25zdCBOb1RpY2tldHMgPSBub1RpY2tldHMgfHwgVGlja2V0c05vVGlja2V0cztcbiAgLy8gY29uc29sZS5sb2coZnNJdGVtKTtcbiAgcmV0dXJuIChcbiAgICA8TGlzdEdyb3VwIGNsYXNzTmFtZT1cInRpY2tldHNcIj5cbiAgICAgIHtyZXNwb25zZS5sZW5ndGhcbiAgICAgICA/IHJlc3BvbnNlLm1hcCgodGlja2V0KSA9PiBmc0l0ZW0oe3RpY2tldCwga2V5OiB0aWNrZXQuaWR9KSlcbiAgICAgICA6IE5vVGlja2V0cygpfVxuICAgIDwvTGlzdEdyb3VwPlxuICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBOb3RpY2Vib2FyZDtcbiJdfQ==